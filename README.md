## Погодный RestAPI для Telegram-бота с хранением результатов запросов в реляционной базе данных.

Целью проекта являлось создание готового функционала, реализующего запросы к погодному API и храненящего результаты запросов в РБД, поверх которого с использованием любого фреймворка (синхронного или асинхронного) создается API телеграм-бота.

### Основные методы работы:
1. #### Погодный API.
Данные о погоде запрашиваются через API сервиса [OpenWeatherMap](https://openweathermap.org/), поэтому для корректной работы сервиса нужен токен.

Существует бесплатный тарифный план для версии API 2.5, который позволяет делать до тысячи запросов в сутки, но и платные тарифы вполне себе доступны, за 30 GBP/mo. можно получить токен, позволяющий делать до 600 запросов в минуту и до 10 миллионов запросов в месяц.

Функционал API-запросов, обработки возможных исключений и ответа вынесен в отдельный класс __ApiRequests__, предполагается, что пользователь не будет непосредственно с ним взаимодействовать, однако его методы не сделаны приватными или защищенными намеренно.

Поскольку _OpenWeatherMapAPI_ требует в запросе указывать географические координаты населенного пункта, предварительно необходимо их получить по имени этого самого населенного пункта. Благо у этого же сервиса есть свой соответствующий API.

Класс __GeoAPP__ и его метод __get__cordinates()__ отвечает за получение по имени населенного пункта его координат. 

Метод принимает в качестве аргумента название населенного пункта на русском, английском языках и возвращает объект класса __City__.

Данный объект хранит в себе информацию о координатах, стране и регионе нахождения населенного пункта.

Непосредственно класс __WeatherApp__ реализует запросы к API посредством метода __get_forecast()__. 

Сигнатура метода:

```python
get_forecast(city_name, date=None, units="metric", lang="ru")
```

Метод принимает в качестве аргумента название название населенного пункта и ряд опциональных параметров:

- date - дата, на которую необходимо получить состояние погоды. Значение по умолчанию: _None_;
- units - единицы измерения: __standart__ (стандартные), __metric__ (метрические), __imperial__ (имперские). Значение по умолчанию: _metric_;
- lang - язык, на котором будет дано общее описание погоды:
> Облачно, возможны осадки в виде фрикаделек.

Список поддерживаемых языков находится [здесь](https://openweathermap.org/current#multi).

Метод возвращает экземпляр класса __WeatherForecast__, в атрибутах которого находится большинство погодных параметров, предоставляемых API:

- weather - словарь основных параметров погоды:

> [{'id': 803, 'main': 'Clouds', 'description': 'облачно с прояснениями', 'icon': '04d'}]

- common: основная погодная характеристика:

> 'Clouds'

- description - текстовое описание погоды на языке,  выбранном пользователем:

> 'облачно с прояснениями'

- main - основной словарь параметров погоды:

> {'temp': 21.19, 'feels_like': 21.3, 'temp_min': 20.25, 'temp_max': 21.71, 'pressure': 1013, 'humidity': 74}

- cur_temp - текущая температура атмосферного воздуха:

> 21.19

- max_temp - максимальная теммпература за сутки:

> 21.71

- min_temp - минимальная температура за сутки:

> 20.25

- feels_like - "ощущается как": 

> 21.3

- humidity - влажность воздуха в процентах:

> 74

- pressure_hpa - давление атмосферного воздуха в гигапаскалях:

> 1013

- pressure_hg_mm - более привычное русскому человеку давление в миллиметрах ртутного столба:

> 760.0

2. #### Работа с БД.

Работа с реляционной базой данных реализована посредством библиотеки SQLAlchemy. 

Структура БД хранится в _database_config.py_.

В общем база представляет собой связанные таблицы _users_ и _weather_reports_.

Первая хранит информацию о пользователях, воспользовавшихся нашим ботом, вторая - все запрошенные погодные отчеты. Внешним ключом для таблицы _weather_reports_ является id таблицы _users_, тип связи "Один ко многим" - один пользователь может запросить несколько погодных отчетов.

Сущности таблицы _users_ описываются классом __User__, имеющим атрибуты:

- id - первичный ключ, номер записи в таблице;
- tg_id - id пользователя в Telegram;
- city - город пользователя, для которого он может запрашивать погодные отчеты (но не только для него);
- connection_date - время подключения, формируется автоматически, определяется с помощью функции _datetime.now()_ модуля _datetime_ стандартной библиотеки Python;
- reports - не является столбцом таблицы, является атрибутом ORM-сущности, списком, в котором хранятся  объекты класса __WeatherReport__, связанные с данным пользователем.

Сущности таблицы _weather_reports_ описываются классом __WeatherReport__, имеющим атрибуты:

- id - первичный ключ, номер записи в таблице;
- owner - внешний ключ, id записи в таблице _users_, запросившего этот отчет;
- date - дата формирования отчета, формируется автоматически, определяется с помощью функции _datetime.now()_ модуля _datetime_ стандартной библиотеки Python;
- temp - температура воздуха;
- feels_like - "ощущается как";
- pressure_mm - атмосферное давление в мм.рт.ст.;
- city - название города, для которого запрошен отчет.

Модуль __orm_runner.py__ хранит основные функции, посредством которых реализуется взаимодействие с БД.

Обязательно требует данных для подключения к БД посредством _psycopg2_, для PostgreSQL:
- имя пользователя,
- пароль,
- хост, на котором крутится СУБД;
- порт, который слушает СУБД;
- название БД.

Функции:

- __add_user(tg_id)__ - принимает id пользователя в Telegram, если такой пользователь отсутствует, добавляет его в БД;
- __add_city(tg_id, city_name)__: принимает id пользователя в Telegram, если такой пользователь отсутствует, добавляет его в БД, добавляет ему атрибут "city";
- __get_user_city(tg_id)__: позволяет получить по id пользователя в Telegram его город;
- __get_all_users(personal_id=None, tg_id=None)__ - возвращает список id всех пользователей в таблице либо их TG-id. Значения по умолчанию обоих параметров функции - _None_. Вызов функции без аргументов вызовет поднятие __MyWeatherappException__-исключения, если будут переданы оба аргумента, приоритет имеет id пользователя в таблице, _tg_id_ будет проигнорирован;
- __add_weather_report(tg_id, city, temp, feels_like, wind_speed, pressure_mm)__ - добавляет в БД отчет о погоде для пользователя с _tg_id_;
- __get_users_reports(tg_id)__ - возвращает список всех погодных отчетов пользователя с переданным в функцию _tg_id_.


### Тестирование.

Необходимость описания тестирования обусловлена тем, что состояние погоды в разные моменты времени в одном и том же месте, очевидно, отличается, что затрудняет тестирование запросов к OpenWeatherMapAPI.

Для решения этой задачи написан небольшой локальный сервер на Flask, который поднимается из _tests/syntetic_server.py_. 

Модуль _test_weather_app.py_ делает запросы, идентичные таковым к настоящему API, сервер принимает запросы и, если они соответствуют заданному эталону, возвращает для одного из городов заранее записанный json с погодным отчетом. В случае ошибки возвращается json с теми заголовками, которые были направлены в запросе, тест падает, но есть возможность посмотреть, какой HTTP-запрос был направлен и как на него отреагировал сервер.